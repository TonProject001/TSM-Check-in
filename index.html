<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSM Check-in</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* เพิ่ม CSS สำหรับจัดรูปแบบ */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        label {
            font-size: 16px;
            margin-bottom: 5px;
            display: block;
            color: #333;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: #007BFF;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .btn-info {
            background-color: #28a745;
        }

        .btn-info:hover {
            background-color: #218838;
        }

    </style>
</head>
<body>

    <div class="container">
        <h2>TSM Check-in</h2>
        <form id="locationForm">
            <label for="name">ชื่อ-นามสกุล:</label>
            <input type="text" id="name" name="name" required><br><br>

            <label for="coordinates">พิกัด (ละติจูด, ลองจิจูด):</label>
            <input type="text" id="coordinates" name="coordinates" readonly><br><br>

            <button type="button" onclick="getLocation()" class="btn-info">ดึงพิกัดอัตโนมัติ</button><br><br>
            <button type="submit">บันทึกข้อมูล</button>
        </form>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyTmELpnUute3Nk4KraqcPUnWFcISA8P91GAYHM3rgPV8my-CcWWkvfKRC0ewg2Dg3_HA/exec';
        const form = document.getElementById('locationForm');

        // พิกัดเป้าหมาย
        const TARGET_LAT = 16.8728852;
        const TARGET_LNG = 99.1314056;
        const ALLOWED_RADIUS = 50;  // ระยะห่างที่ยอมให้เช็คอิน (เมตร)

        // ฟังก์ชันคำนวณระยะห่างระหว่างสองพิกัด (ใช้สูตร Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;  // รัศมีของโลกในเมตร
            const φ1 = lat1 * Math.PI / 180;  // แปลงละติจูดจากองศาเป็นเรเดียน
            const φ2 = lat2 * Math.PI / 180;  // แปลงละติจูดจากองศาเป็นเรเดียน
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;  // ระยะทางในเมตร
        }

        // ดึงพิกัดจาก GPS
       function getLocation() {
    Swal.fire({ 
        title: 'กำลังตรวจสอบพิกัด...', 
        allowOutsideClick: false, 
        didOpen: () => { Swal.showLoading(); } 
    });

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            document.getElementById('coordinates').value = `${latitude.toFixed(8)}, ${longitude.toFixed(8)}`;
            
            // คำนวณระยะห่างจากจุดเช็คอิน
            const distance = calculateDistance(latitude, longitude, TARGET_LAT, TARGET_LNG);

            // แสดงระยะห่างจากจุดเช็คอิน
            Swal.fire({
                title: 'สำเร็จ',
                text: `ระยะห่างจากจุดเช็คอิน: ${distance.toFixed(2)} เมตร`,
                icon: 'success',
                showConfirmButton: true
            });
        },
        () => Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงพิกัดได้', 'error'),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}


        form.addEventListener('submit', function(e) {
            e.preventDefault();  // ป้องกันการรีเฟรชหน้าเมื่อส่งฟอร์ม

            const name = document.getElementById('name').value;
            const coordinates = document.getElementById('coordinates').value;

            // ตรวจสอบว่ามีพิกัดหรือไม่
            if (!coordinates) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาดึงพิกัดก่อนบันทึก', 'error');
                return;
            }

            const [latitude, longitude] = coordinates.split(',').map(coord => parseFloat(coord.trim()));

            // คำนวณระยะห่างจากพิกัดที่กำหนด
            const distance = calculateDistance(latitude, longitude, TARGET_LAT, TARGET_LNG);

            // เช็คว่าอยู่ในระยะที่อนุญาตหรือไม่
            if (distance > ALLOWED_RADIUS) {
                Swal.fire('ข้อผิดพลาด', `ระยะห่างเกิน ${ALLOWED_RADIUS} เมตรจากจุดเช็คอิน`, 'error');
                return;
            }

            // สร้าง URLSearchParams สำหรับส่งข้อมูล
            const params = new URLSearchParams({
                name: name,
                latitude: latitude,
                longitude: longitude
            });

            // ส่งข้อมูลไปยัง Google Apps Script
            fetch(scriptURL + '?' + params.toString())
                .then(response => response.text())  // อ่านข้อมูลที่ส่งกลับ
                .then(() => {
                    Swal.fire('สำเร็จ', 'ข้อมูลถูกบันทึกเรียบร้อย', 'success');
                    form.reset();  // รีเซ็ตฟอร์มหลังจากส่งข้อมูล
                })
                .catch(() => {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                });
        });
    </script>

</body>
</html>
